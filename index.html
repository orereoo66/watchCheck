<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>スターウォーズ1〜6 視聴チェック</title>
<style>
  :root{--bg:#0f1115;--panel:#161922;--ink:#e8ecf1;--muted:#9aa4b2;--accent:#4ade80;--danger:#f87171;--warn:#fbbf24;--line:#2a2f3a}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.9);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px 0;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .progress{height:10px;background:#1d2230;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#34d399,#22c55e);width:0%}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
  select,button,input,textarea{background:#141823;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:16px;outline:none}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#1f7a4a,#136a41);border-color:#1c7a4a}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#141823;cursor:pointer}
  .tab.active{background:#1f2937}
  .q{border:1px dashed #2d3444;border-radius:12px;padding:12px}
  .q h3{margin:0 0 6px 0;font-size:16px}
  .meta{font-size:12px;color:var(--muted)}
  .opts{display:grid;gap:6px;margin-top:6px}
  .opt{display:flex;align-items:flex-start;gap:8px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#141823}
  .opt input{margin-top:2px}
  .judge{font-size:14px;margin-top:6px}
  .judge.correct{color:var(--accent)} .judge.partial{color:var(--warn)} .judge.wrong{color:var(--danger)}
  .only-results header{position:static}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width:700px){.stats{grid-template-columns:repeat(2,1fr)}}
  .stat{background:#141823;border:1px solid var(--line);border-radius:12px;padding:12px}
  .stat b{font-size:24px;display:block;margin-top:6px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:14px}
  .ok{color:var(--accent)} .ng{color:var(--danger)} .pt{color:var(--warn)}
  details.ex{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;background:#121623}
  details.ex summary{cursor:pointer}
  .tagbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  @media print{.no-print{display:none!important} body{background:#fff;color:#000} .panel{border:1px solid #ccc}}


/* 小画面で横スクロール可に（テーブル/パネルのはみ出し対策） */
.panel{overflow-x:auto}

/* タブを横スクロール可能に（指でスワイプ） */
.tabs{overflow:auto; -webkit-overflow-scrolling:touch}
.tabs::-webkit-scrollbar{display:none}

/* デフォルトは溢れさせない＝スクロールバーを出さない */
.tabs{ overflow:visible; }

/* 小画面だけ横スクロール可能に */
@media (max-width:700px){
  .tabs{ overflow:auto; -webkit-overflow-scrolling:touch; }
  .tabs::-webkit-scrollbar{ display:none; }
}
  
:root{
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
}
header{padding-top:calc(var(--safe-top)/2)}
main{padding-bottom:calc(12px + var(--safe-bottom))}


@media (max-width:480px){
  .wrap{padding:12px}
  .row{gap:8px}
  .tab{padding:8px 10px}
  .opt{padding:10px 12px}
  .opt input{transform:scale(1.2)} /* タップしやすく */
  table{font-size:13px}
  th,td{padding:8px}
}

:root{ --elev: 0 6px 18px rgba(0,0,0,.28); --fast:150ms; --norm:220ms; --slow:420ms }
@media (prefers-reduced-motion: reduce){
  *{ animation:none!important; transition:none!important }
}


.panel{ transition: transform var(--norm) ease, box-shadow var(--norm) ease }
.panel:hover{ transform: translateY(-2px); box-shadow: var(--elev) }


.tabs{ position:relative; gap:6px }
.tab{ position:relative; transition: background var(--fast) ease, transform var(--fast) ease }
.tab:active{ transform: scale(.98) }
.tab::after{
  content:""; position:absolute; left:10px; right:10px; bottom:-6px; height:2px;
  background:linear-gradient(90deg,#34d399,#22c55e);
  opacity:0; transform: scaleX(.5); transform-origin:left; transition: all var(--norm) ease
}
.tab.active::after{ opacity:1; transform: scaleX(1) }


.progress{ overflow:hidden; position:relative }
.bar{ transition: width var(--slow) cubic-bezier(.22,.8,.18,1) }
.bar::after{
  content:""; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.16),transparent);
  transform:translateX(-100%); animation: sweep 2.2s linear infinite
}
@keyframes sweep{ to{ transform:translateX(100%) } }


.opt{ transition: border-color var(--fast), background var(--fast) }
.opt input{ appearance:none; width:20px; height:20px; border:2px solid var(--line); border-radius:6px; margin-top:0; position:relative; flex:0 0 20px; outline:none; transition: all var(--fast) }
.opt input::after{
  content:""; position:absolute; inset:2px; border-radius:4px; transform: scale(.2); opacity:0; background:var(--accent);
  transition: transform var(--fast), opacity var(--fast)
}

.opt input[type="radio"]{ border-radius:999px }
.opt input[type="radio"]::after{ border-radius:999px }

.opt input:checked{ border-color:#34d399; box-shadow:0 0 0 3px rgba(52,211,153,.15) }
.opt input:checked::after{ opacity:1; transform: scale(1) }
.opt:has(input:checked){ background:#17202b }


button, .tab, select, input{ outline:none }
button:focus-visible, .tab:focus-visible, select:focus-visible, .opt input:focus-visible{
  box-shadow:0 0 0 3px rgba(59,130,246,.35)
}


.judge{ opacity:.9; transform: translateY(2px); transition: all var(--norm) ease }
.q:hover .judge{ opacity:1; transform: translateY(0) }


details.ex{ overflow:hidden; transition: grid-template-rows var(--slow) ease, padding var(--slow) ease }
details.ex[open]{ animation: none }
details.ex .meta{ transition: opacity var(--norm) ease }
details.ex:not(.open) .meta{ opacity:0 }
details.ex.open .meta{ opacity:1 }


header.scrolled{ box-shadow: 0 6px 20px rgba(0,0,0,.3) }
main.wrap.grid{ position:relative; }
.view{
  position:relative;
  opacity:1;
  transform:translateX(0);
}
.view.hide{ 
  display:none;
}
  
main.animating .view{
  position:absolute;
  inset:0;
  display:block;
}
  
:root{ --slide-ms: 360ms; }
@media (prefers-reduced-motion: reduce){
  .view{ transition:none!important; transform:none!important; opacity:1!important; }
}

.view{ 
  transition: transform var(--slide-ms) cubic-bezier(.22,.8,.18,1), 
              opacity var(--slide-ms) ease;
  will-change: transform, opacity;
  opacity:1; 
  transform: translateX(0);
}
.view.enter-from-right{ transform: translateX(12%); opacity:.01; }
.view.enter-from-left { transform: translateX(-12%); opacity:.01; }
.view.exit-to-left    { transform: translateX(-100%); opacity:0; }
.view.exit-to-right   { transform: translateX(100%); opacity:0; }
.view{ position:absolute; inset:0; 
       transition: transform var(--slide-ms) cubic-bezier(.22,.8,.18,1),
                   opacity var(--slide-ms) ease;
       will-change: transform, opacity;
       opacity:1; transform: translateX(0); }

/* ←これが足りてなかった！ 非アクティブ面は完全に透明＆クリック不可に */
.view.hide{ opacity:0; pointer-events:none; }
main.animating{ overflow:hidden; }
  
</style>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f1115">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>
<header class="no-print">
  <div class="wrap">
    <h1>スターウォーズ 1〜6 視聴チェック</h1>
    <div class="row">
      <div class="pill">進捗: <span id="progressPct">0%</span></div>
      <div class="row" style="margin-left:auto;gap:8px">
        <select id="gradeScope" title="採点範囲を選択">
          <option value="ep" selected>このEPのみ</option>
          <option value="answered">回答済みのみ</option>
          <option value="all">全エピソード</option>
        </select>
        <button id="grade" class="primary">採点する（結果ページへ）</button>
        <button id="resetAll">全てリセット</button>
        <button id="exportData">結果をエクスポート</button>
        <button id="printPage" class="no-print">印刷 / PDF保存</button>
      </div>
    </div>
    <div class="progress" style="margin-top:8px;"><div class="bar" id="bar"></div></div>
  </div>
</header>

<main class="wrap grid" style="margin-top:12px">
  <!-- QUIZ VIEW -->
  <section id="view-quiz" class="grid">
    <section class="panel">
      <div class="row" style="align-items:flex-end">
        <div>
          <div class="meta">表示するエピソード</div>
          <div class="tabs" id="tabs"></div>
        </div>
        <div style="margin-left:auto" class="row">
          <label class="meta"><input type="checkbox" id="onlyUnanswered"> 未回答のみ</label>
          <label class="meta"><input type="checkbox" id="showAnswers"> 正解を表示</label>
          <label class="meta"><input type="checkbox" id="showExplain" checked> 解説を表示</label>
        </div>
      </div>
    </section>
    <section id="quizZone" class="grid"></section>
  </section>

  <!-- RESULTS VIEW -->
  <section id="view-results" class="grid">
    <section class="panel">
      <div class="row" style="gap:8px;align-items:center">
        <h2 style="margin:0">結果</h2>
        <span class="pill" id="modeBadge">5択・完全一致採点（部分正解は参考）</span>
        <div class="row" style="margin-left:auto;gap:8px">
          <button id="backToQuiz" class="no-print">← 問題に戻る</button>
          <button id="printPage2" class="no-print">印刷 / PDF保存</button>
        </div>
      </div>
      <div class="stats" style="margin-top:10px">
        <div class="stat"><span>正解</span><b id="statCorrect">—</b></div>
        <div class="stat"><span>部分正解</span><b id="statPartial">—</b></div>
        <div class="stat"><span>全問題数</span><b id="statTotal">—</b></div>
        <div class="stat"><span>スコア%</span><b id="statPct">—%</b></div>
      </div>
    </section>

    <section class="panel">
      <h3 style="margin-top:0">エピソード別内訳</h3>
      <table id="epBreakdown">
        <thead><tr><th>EP</th><th>正解</th><th>部分</th><th>合計</th><th>正答率</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="panel">
      <h3 style="margin-top:0">誤答・部分正解の見直し</h3>
      <table id="wrongTable">
        <thead><tr><th style="width:36px">EP</th><th>問題</th><th style="width:36%">あなたの選択</th><th style="width:28%">正解</th><th>判定</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </section>
</main>

<script>
/* ========= データ（省略なし・あなたのQAをそのまま使用） ========= */
const QA = {
  1: [
    { q:"パドメ（女王）の初期衣装・化粧の特徴はどれ？",
      multi:true, choices:["白塗りの顔","下唇中央の赤い縦線","金属質の王冠状ヘッドピース","黒い涙のメイク","青い肌"], correct:[0,1,2],
      loc:"ナブー／シード王宮・玉座の間ほか", time:"0:07",
      explain:"ナブー王家の伝統化粧には下唇中央の『追憶の傷』が含まれます。アミダラは白塗り＋金属質ヘッドピースと併用。",
      sources:["https://starwars.fandom.com/wiki/Scar_of_remembrance","https://starwars.fandom.com/wiki/Padm%C3%A9_Amidala"] },
    { q:"タトゥイーンの自宅でのアナキンの性格描写として当てはまるものは？",
      multi:true, choices:["機転が利く","臆病","メカに強い","嘘つき","他者への共感が強い"], correct:[0,2,4],
      loc:"タトゥイーン／アナキンの家", time:"0:45",
      explain:"アナキンは自作ドロイドを披露し、見知らぬ来訪者を助けようとする描写が並びます。",
      sources:["https://www.starwars.com/databank/anakin-skywalker","https://www.starwars.com/databank/protocol-droid"] },
    { q:"タトゥイーンの自宅でアナキンが直していたもの",
      multi:false, choices:["C-3PO","R2-D2","AT-TE","ランドスピーダー","ライトセーバー"], correct:[0],
      loc:"タトゥイーン／アナキンの家", time:"0:46",
      explain:"C-3POは『若きアナキンが母を助けるために作った』と公式データバンクに明記。",
      sources:["https://www.starwars.com/databank/c-3po","https://www.starwars.com/video/c-3po-meets-r2-d2"] },
    { q:"ポッドレースでアナキンのポッドがスタート直後に停止した描写に近いものは？",
      multi:false, choices:["機械トラブルによる失火","サブルバの妨害","タトゥイーンの砂嵐","給油不足","ジャワの攻撃"], correct:[0],
      loc:"タトゥイーン／モス・エスパ・グランドアリーナ", time:"1:05",
      explain:"スタートでアナキン機が一瞬沈黙。別の機体（ベン・クアディナロス）は完全に故障で発進不能。",
      sources:["https://starwars.fandom.com/wiki/Boonta_Eve_Classic","https://starwars.fandom.com/wiki/BT310_Quadra"] },
    { q:"元老院の議場でカメオ的に見える宇宙人",
      multi:false, choices:["E.T.の種族","バルカン人","プレデター","ナヴィ","クリプトニアン"], correct:[0],
      loc:"コルサント／銀河元老院議場", time:"1:20",
      explain:"『E.T.』由来のアソジアン（Asogian）議員がカメオ出演します。",
      sources:["https://starwars.fandom.com/wiki/Asogian","https://starwars.fandom.com/wiki/Grebleips"] },
    { q:"ジェダイ評議会がアナキンの訓練に難色を示した主理由",
      multi:false, choices:["年齢が高い","フォース感知不能","出自が不明","既に師を持っている","ドロイド差別"], correct:[0],
      loc:"コルサント／ジェダイ評議会の間", time:"1:28",
      explain:"『年齢（遅すぎる訓練開始）＝執着の芽』を警戒する評議会の方針が示されます。",
      sources:["https://starwars.fandom.com/wiki/Jedi_Code","https://www.starwars.com/databank/anakin-skywalker"] },
    { q:"ナブー宮殿の床の意匠に近いもの",
      multi:false, choices:["大理石調の幾何学模様","木目の寄木細工","藁の敷き詰め","カーペット一色","砂利敷き"], correct:[0],
      loc:"ナブー／シード王宮", time:"1:50",
      explain:"大理石調の幾何学（チェッカー風）の床面が特徴。",
      sources:["https://starwars.fandom.com/wiki/Theed"] },
    { q:"ダース・モール戦のクワイ＝ガン死亡直後のオビ＝ワンの対応",
      multi:false, choices:["感情的に突撃","撤退命令","モールを挑発して待つ","ライトセーバーを捨てる","ヨーダを呼ぶ"], correct:[0],
      loc:"ナブー／発電施設（シールドゲートエリア）", time:"1:56",
      explain:"師を倒された直後、オビ＝ワンは勢いでモールに突撃し形勢逆転を狙います。",
      sources:["https://starwars.fandom.com/wiki/Duel_of_the_Fates"] },
    { q:"ナブー解放戦での宇宙戦で決定打となったのは？",
      multi:false, choices:["アナキンが艦のリアクターを爆破","ガンガン大砲の直撃","貿易連合の内部反乱","ジャー・ジャーの交渉","ジンの幽体離脱"], correct:[0],
      loc:"軌道上／ドロイド管制艦内部", time:"2:05",
      explain:"アナキンが偶発的に突入→リアクター破壊。地上のドロイドは一斉停止。",
      sources:["https://starwars.fandom.com/wiki/Trade_Federation_droid_control_ship"] },
    { q:"ジェダイの規律として作中で示される禁止に近いもの",
      multi:true, choices:["執着","恐れ","怒り","結婚一般","音楽の使用"], correct:[0,1,2,3],
      loc:"全般（評議会の方針／ジェダイ・コード）", time:"1:28",
      explain:"『執着・恐れ・怒り』は暗黒面の入口。結婚（強い情的な結びつき）も原則禁忌として描かれます。",
      sources:["https://starwars.fandom.com/wiki/Jedi_Code","https://starwars.fandom.com/wiki/Attachment"] }
  ],
  2: [
    { q:"冒頭の暗殺計画で用いられた手段",
      multi:true, choices:["毒虫による殺害","爆弾","スナイパー","毒ガス","毒入り飲料"], correct:[0,1],
      loc:"コルサント／パドメの宿舎ほか", time:"0:05",
      explain:"ザム・ウェセルがドロイド経由で『コウフン（毒虫）』を送り込み、別シーンで船爆破も発生。",
      sources:["https://starwars.fandom.com/wiki/Zam_Wesell","https://starwars.fandom.com/wiki/Kouhun"] },
    { q:"カミーノ星系の気候描写",
      multi:false, choices:["豪雨と嵐","雪原","砂漠","温暖湿潤の森","氷海"], correct:[0],
      loc:"カミーノ／ティポカ・シティ", time:"0:48",
      explain:"常時豪雨・高波の洋上都市。到着シーンから一貫して荒天。",
      sources:["https://www.starwars.com/databank/clone-troopers","https://starwars.fandom.com/wiki/Kamino"] },
    { q:"クローン計画に関与した賞金稼ぎ",
      multi:false, choices:["ジャンゴ・フェット","ボバ・フェット","オーラ・シング","キャド・ベイン","IG-88"], correct:[0],
      loc:"カミーノ／クローン施設", time:"0:52",
      explain:"クローンは『ジャンゴ・フェットの遺伝子テンプレート』から作製。",
      sources:["https://www.starwars.com/databank/clone-troopers","https://starwars.fandom.com/wiki/Jango_Fett"] },
    { q:"オビ＝ワンが宇宙で追跡戦を行った相手",
      multi:false, choices:["ジャンゴ・フェット","ドゥークー","ハン・ソロ","グリーヴァス","ザム・ウェセル"], correct:[0],
      loc:"小惑星帯（カミーノ→ジオノーシス）", time:"1:02",
      explain:"スレーブIの音波爆雷からの回避・追跡シークエンス。",
      sources:["https://starwars.fandom.com/wiki/Slave_I","https://starwars.fandom.com/wiki/Seismic_charges"] },
    { q:"アナキンが母の件でタスケン・レイダーの集落で行ったこと",
      multi:false, choices:["怒りで皆殺しにした","交渉して解放","秘密裏に記念碑を建てた","捕虜交換","何もしなかった"], correct:[0],
      loc:"タトゥイーン／タスケンの集落", time:"1:25",
      explain:"母の死をきっかけにアナキンは怒りに呑まれ、住民を虐殺します。",
      sources:["https://starwars.fandom.com/wiki/Anakin_Skywalker","https://starwars.fandom.com/wiki/Tusken_Raiders"] },
    { q:"議会で『非常時権限』を与えられた人物",
      multi:false, choices:["パルパティーン","ベイル・オーガナ","マス・アメダ","モン・モスマ","ティオン・メドン"], correct:[0],
      loc:"コルサント／銀河元老院", time:"1:35",
      explain:"分離主義危機を口実に、パルパティーンへ非常大権が付与されます。",
      sources:["https://starwars.fandom.com/wiki/Galactic_Senate","https://starwars.fandom.com/wiki/Palpatine"] },
    { q:"ドゥークー伯爵がオビ＝ワンに提示した提案",
      multi:false, choices:["シス打倒の共闘","共和国離脱","ジェダイ辞職勧告","ジェダイ資料の売買","亡命斡旋"], correct:[0],
      loc:"ジオノーシス／拘束室", time:"1:40",
      explain:"ドゥークーは評議会に潜むシスの存在を示唆し、共闘を持ちかけます。",
      sources:["https://starwars.fandom.com/wiki/Count_Dooku"] },
    { q:"ジオノーシスの処刑場で放たれたクリーチャー",
      multi:true, choices:["リク","アクレイ","ネクスー","ランコア","バーサク"], correct:[0,1,2],
      loc:"ジオノーシス／円形アリーナ", time:"1:53",
      explain:"三獣同時投入の見世物。ランコアは本作では登場しません。",
      sources:["https://starwars.fandom.com/wiki/Acklay","https://starwars.fandom.com/wiki/Nexu","https://starwars.fandom.com/wiki/Reek"] },
    { q:"ヨーダが戦場に現れるときの移動手段",
      multi:false, choices:["ガンシップ","ビースト騎乗","徒歩","ジェットパック","スピーダーバイク"], correct:[0],
      loc:"ジオノーシス上空～戦場", time:"2:00",
      explain:"共和国のLAAT/iガンシップで介入、ジェダイを回収します。",
      sources:["https://starwars.fandom.com/wiki/LAAT/i_gunship","https://starwars.fandom.com/wiki/Yoda"] },
    { q:"アナキンとパドメの関係に関する出来事",
      multi:false, choices:["秘密裏に結婚した","婚約破棄","正式に公表","別居開始","別人と結婚"], correct:[0],
      loc:"ナブー／湖水地方（別荘）", time:"2:18",
      explain:"映画ラストで極秘の結婚式。式場はナブーの湖畔の別荘。",
      sources:["https://starwars.fandom.com/wiki/Anakin_Skywalker","https://starwars.fandom.com/wiki/Padm%C3%A9_Amidala"] }
  ],
  3: [
    { q:"序盤の救出でアナキンがドゥークーに止めを刺す直前のパルパティーンの発言",
      multi:false, choices:["殺せ","助けろ","捕虜にせよ","逃げろ","忘れろ"], correct:[0],
      loc:"コルサント上空／分離主義勢力の旗艦内", time:"0:12",
      explain:"パルパティーンが“Do it.”と明確に殺害を促します。",
      sources:["https://starwars.fandom.com/wiki/Chancellor_Palpatine","https://starwars.fandom.com/wiki/Dooku"] },
    { q:"オーダー66により何が起きたか",
      multi:true, choices:["ジェダイ一斉粛清","クローンの反乱","共和国軍の離反","パルパティーンの非常大権行使","元老院の掌握"], correct:[0,3,4],
      loc:"銀河各地（同時多発）", time:"1:37",
      explain:"クローンへ一斉通達されたジェダイ抹殺命令。非常大権の行使と体制掌握の流れが映像化されます。",
      sources:["https://starwars.fandom.com/wiki/Order_66","https://starwars.fandom.com/wiki/Galactic_Empire"] },
    { q:"オビ＝ワンとグリーヴァスが戦った惑星",
      multi:false, choices:["ウータパウ","ムスタファー","コルサント","ジオノーシス","カシーク"], correct:[0],
      loc:"ウータパウ／第10大穴（ポー市）", time:"1:17",
      explain:"オビ＝ワンはボーガ（蜥蜴）に騎乗し、グリーヴァスと交戦。",
      sources:["https://starwars.fandom.com/wiki/Utapau","https://starwars.fandom.com/wiki/General_Grievous"] },
    { q:"アナキンがダークサイドに傾いた主因に近いもの",
      multi:true, choices:["喪失への恐れ","パルパティーンの操作","ジェダイ評議会への不信","富への欲望","フォース喪失"], correct:[0,1,2],
      loc:"コルサント中心／パルパティーンの私室ほか", time:"1:00",
      explain:"『喪失の恐怖』を突いた誘導と、評議会への不信が臨界点に。",
      sources:["https://www.starwars.com/databank/anakin-skywalker","https://starwars.fandom.com/wiki/Darth_Sidious"] },
    { q:"ジェダイ聖堂突入時の空の様子",
      multi:false, choices:["夕焼け","快晴","嵐","夜","雪"], correct:[0],
      loc:"コルサント／ジェダイ聖堂外観", time:"1:42",
      explain:"夕焼け空の下、501大隊を率いてアナキンが進軍します。",
      sources:["https://starwars.fandom.com/wiki/Jedi_Temple"] },
    { q:"ムスタファーでの最終決闘の結末",
      multi:false, choices:["アナキンが重傷を負い救出される","オビ＝ワンが死亡","相打ち","誰も負傷しない","皇帝が倒される"], correct:[0],
      loc:"ムスタファー／溶岩流上の採掘施設", time:"2:05",
      explain:"四肢喪失・重度熱傷のアナキンが後に機械化されます。",
      sources:["https://starwars.fandom.com/wiki/Duel_on_Mustafar"] },
    { q:"ダース・ヴェイダーの誕生直後に行われたこと",
      multi:true, choices:["パドメの死","双子の分散保護","共和国の帝国化宣言","デス・スター計画の継続","惑星ナブーでの葬儀"], correct:[0,1,3,4],
      loc:"コルサント／医療施設→元老院・ナブー", time:"2:10",
      explain:"ヴェイダー誕生と並行して帝国成立、双子は別々に託され、ナブーでパドメの葬儀。",
      sources:["https://starwars.fandom.com/wiki/Galactic_Empire","https://starwars.fandom.com/wiki/Padm%C3%A9_Amidala"] },
    { q:"アナキンがパドメにした行為",
      multi:false, choices:["フォースで首を絞めた","ライトニングを放つ","拘束具で拘束","説得だけで離す","治癒のフォース"], correct:[0],
      loc:"ムスタファー／着陸場", time:"1:56",
      explain:"嫉妬と被害妄想の末、フォースで絞殺しかけます。",
      sources:["https://starwars.fandom.com/wiki/Padm%C3%A9_Amidala","https://starwars.fandom.com/wiki/Anakin_Skywalker"] },
    { q:"シスの掟に近いもの",
      multi:false, choices:["二人制の師弟","三人制","評議会制","多数決制","輪番制"], correct:[0],
      loc:"総論（シスの伝統）", time:"—",
      explain:"“Always two there are, no more, no less.”（師匠と弟子の二人）。",
      sources:["https://starwars.fandom.com/wiki/Rule_of_Two"] },
    { q:"ヨーダが最終的に身を潜めた先",
      multi:false, choices:["ダゴバ","オルデラン","タトゥイーン","ホス","ベスピン"], correct:[0],
      loc:"ダゴバ／沼地", time:"2:14",
      explain:"オーダー66後、ヨーダは辺境の惑星ダゴバに隠遁します。",
      sources:["https://www.starwars.com/databank/yoda"] }
  ],
  4: [
    { q:"ラーズ家の食卓で映る飲み物の色として印象的なもの",
      multi:false, choices:["青","赤","緑","透明","黄色"], correct:[0],
      loc:"タトゥイーン／ラーズ家（食卓）", time:"0:17",
      explain:"通称ブルーミルク（バンサ・ミルク）。初登場はEP4の夕食シーン。",
      sources:["https://starwars.fandom.com/wiki/Blue_milk","https://www.starwars.com/news/princess-leia-rice-bowl-recipe"] },
    { q:"ルークがライトセーバーを初めて受け取った場所",
      multi:false, choices:["オビ＝ワンの家","ラーズ家のガレージ","酒場","宇宙船内","帝国基地"], correct:[0],
      loc:"タトゥイーン／オビ＝ワンの家", time:"0:30",
      explain:"旧三部作の象徴的シーン。“お前の父の武器だ”。",
      sources:["https://starwars.fandom.com/wiki/Lightsaber","https://starwars.fandom.com/wiki/Obi-Wan_Kenobi"] },
    { q:"R2-D2が運んでいた重要データ",
      multi:false, choices:["デス・スターの設計図","帝国の給与明細","ジェダイの名簿","貿易協定","惑星図書"], correct:[0],
      loc:"全編の動機（R2内メモリ）", time:"0:38",
      explain:"レイアが託したデス・スター設計図（と救援メッセージ）。",
      sources:["https://starwars.fandom.com/wiki/Death_Star_plans","https://starwars.fandom.com/wiki/R2-D2"] },
    { q:"ハン・ソロの初登場シーンに関わる場所",
      multi:false, choices:["モス・アイズリーの酒場","ジャバの宮殿","エコー基地","クラウド・シティ","デス・スター"], correct:[0],
      loc:"タトゥイーン／モス・アイズリー酒場", time:"0:41",
      explain:"ここでミレニアム・ファルコンの契約＆グリードとの対峙。",
      sources:["https://starwars.fandom.com/wiki/Han_Solo","https://starwars.fandom.com/wiki/Chalmun%27s_Spaceport_Cantina"] },
    { q:"ハンとチューバッカの船の名前",
      multi:false, choices:["ミレニアム・ファルコン","ゴースト","アウトライダー","スレーブI","レイザークレスト"], correct:[0],
      loc:"—", time:"0:43",
      explain:"反乱軍の象徴的船名。以後の作品でも主役級に登場。",
      sources:["https://starwars.fandom.com/wiki/Millennium_Falcon"] },
    { q:"ゴミ圧縮機にいたクリーチャーの特徴",
      multi:true, choices:["触手","単眼","潜伏して引きずる","飛行する","酸の唾液"], correct:[0,1,2],
      loc:"デス・スター／ゴミ圧縮機（牢獄区画付近）", time:"1:18",
      explain:"ディアノーガは単眼の触手型生物で、潜伏からの引き込み攻撃が特徴。",
      sources:["https://www.starwars.com/databank/dianoga","https://starwars.fandom.com/wiki/Dianoga"] },
    { q:"オビ＝ワンとダース・ベイダーの戦闘の結末",
      multi:false, choices:["オビ＝ワンが消失","ベイダーが消失","相打ち","逃走で中断","観戦のみ"], correct:[0],
      loc:"デス・スター／ハンガー区画", time:"1:25",
      explain:"オビ＝ワンは自ら刃を受け霊体化し、ルークらの脱出に繋げます。",
      sources:["https://starwars.fandom.com/wiki/Duel_on_the_Death_Star"] },
    { q:"デス・スター攻撃でルークが頼りにしたもの",
      multi:false, choices:["フォースの直感","コンピューター計算","C-3POの助言","運任せ","奇跡の機械"], correct:[0],
      loc:"ヤヴィン戦・トレンチラン", time:"1:55",
      explain:"計器を切り、フォースに身を委ねてプロトン魚雷を射出。",
      sources:["https://starwars.fandom.com/wiki/Battle_of_Yavin","https://starwars.fandom.com/wiki/Proton_torpedo"] },
    { q:"デス・スターの弱点に関わる設定",
      multi:true, choices:["熱排気口","トレンチ走行","プロトン魚雷","盾の不在","内部からの爆発連鎖"], correct:[0,1,2,4],
      loc:"ヤヴィン戦", time:"1:45",
      explain:"熱排気口へ魚雷直撃→連鎖爆発。外部防護盾は未装備（第二では改良）。",
      sources:["https://starwars.fandom.com/wiki/Death_Star#Design","https://starwars.fandom.com/wiki/Battle_of_Yavin"] }
  ],
  5: [
    { q:"ホスで帝国が用いた地上兵器",
      multi:false, choices:["AT-AT","AT-RT","AT-TE","ドロイデカ","AAT"], correct:[0],
      loc:"ホス／エコー基地前面", time:"0:28",
      explain:"四脚の強襲歩行兵器AT-ATが主力として登場。",
      sources:["https://starwars.fandom.com/wiki/AT-AT_walker"] },
    { q:"ホスの反乱軍基地の壁の質感・色",
      multi:false, choices:["氷の白","金属パネルの黒","岩の茶","木造の茶","ガラス張り"], correct:[0],
      loc:"ホス／エコー基地内部", time:"0:08",
      explain:"氷壁を掘削した通路と白い凍結面が画面を占めます。",
      sources:["https://starwars.fandom.com/wiki/Hoth#Echo_Base"] },
    { q:"ファルコン号が隠れた巨大生命体が潜む場所",
      multi:false, choices:["小惑星の洞窟","デス・スター内部","惑星ナブーの湖底","宇宙クジラの背中","スター・デストロイヤーの格納庫"], correct:[0],
      loc:"小惑星帯（洞窟＝エグゾゴースの体内）", time:"0:53",
      explain:"『洞窟』だと思った場所は宇宙ナメクジ＝エグゾゴースの体内。",
      sources:["https://www.starwars.com/databank/space-slug","https://starwars.fandom.com/wiki/Exogorth"] },
    { q:"ルークがヨーダと出会った惑星",
      multi:false, choices:["ダゴバ","コルサント","タトゥイーン","ムスタファー","ナブー"], correct:[0],
      loc:"ダゴバ／沼地", time:"0:43",
      explain:"フォース修行の舞台となる孤絶の湿地惑星。",
      sources:["https://www.starwars.com/databank/yoda","https://starwars.fandom.com/wiki/Dagobah"] },
    { q:"ルークが離脱した理由に近いもの",
      multi:true, choices:["仲間の危機を感じた","訓練の長期化への焦り","ヨーダの許可","皇帝の指示","ハンへの借金"], correct:[0,1],
      loc:"ダゴバ→ベスピン", time:"1:21",
      explain:"ビジョンで“仲間の危機”を感知し、未完の訓練を断念して出立。",
      sources:["https://starwars.fandom.com/wiki/Luke_Skywalker","https://starwars.fandom.com/wiki/Dagobah"] },
    { q:"クラウド・シティの統治者",
      multi:false, choices:["ランド・カルリジアン","サビーヌ・レン","ベイル・オーガナ","タルキン","サーガ"], correct:[0],
      loc:"ベスピン／クラウド・シティ", time:"1:28",
      explain:"ランドは行政長官として都市を運営。",
      sources:["https://starwars.fandom.com/wiki/Lando_Calrissian","https://starwars.fandom.com/wiki/Cloud_City"] },
    { q:"レイアがハンに言った有名な一言（日本語訳）",
      multi:false, choices:["愛してる","大嫌い","戻らないで","無茶はしないで","さよなら"], correct:[0],
      loc:"クラウド・シティ／カーボン凍結室", time:"1:39",
      explain:"原文“I love you.”—“I know.”の前半。日本語字幕・吹替で『愛してる』。",
      sources:["https://starwars.fandom.com/wiki/I_love_you._I_know.","https://starwars.fandom.com/wiki/Leia_Organa"] },
    { q:"カーボン凍結実験の被験者",
      multi:false, choices:["ハン・ソロ","ルーク","レイア","チューバッカ","ランド"], correct:[0],
      loc:"クラウド・シティ／カーボン凍結室", time:"1:40",
      explain:"ルーク凍結の事前テストとしてハンが凍結されます。",
      sources:["https://starwars.fandom.com/wiki/Carbon-freezing_process","https://starwars.fandom.com/wiki/Han_Solo"] },
    { q:"ベスピン内でのベイダーとルークの戦いの主要展開",
      multi:true, choices:["片手を失う","正体告白","カーボン凍結","ブラスター乱射のみ","ライトセーバー決闘"], correct:[0,1,4],
      loc:"クラウド・シティ／通路～坑道～反応炉上", time:"1:52",
      explain:"ルークは右手を失い、『父子』の真相が明かされる。凍結は試みられたが未遂。",
      sources:["https://starwars.fandom.com/wiki/Duel_on_Cloud_City"] },
    { q:"『私はお前の父だ』の後、ルークの反応",
      multi:false, choices:["否定して絶叫","笑って受け入れる","その場で投降","ヨーダを呼ぶ","眠る"], correct:[0],
      loc:"クラウド・シティ／反応炉上の架台", time:"2:02",
      explain:"“Nooooo!”と否定し、身を投げ落ちて脱出。",
      sources:["https://time.com/4788422/best-star-wars-moments/"] }
  ],
  6: [
    { q:"冒頭でレイアが潜入に用いた変装",
      multi:false, choices:["ブーシ","ストームトルーパー","砂漠の商人","ジェダイ僧","トワイレック踊り子"], correct:[0],
      loc:"タトゥイーン／ジャバの宮殿", time:"0:23",
      explain:"レイアは賞金稼ぎブーシに扮して宮殿へ侵入。",
      sources:["https://starwars.fandom.com/wiki/Boushh","https://starwars.fandom.com/wiki/Leia_Organa"] },
    { q:"ジャバの宮殿での救出作戦に関与した要素",
      multi:true, choices:["ルークの交渉→失敗","ランコアとの戦闘","スキッフ上の戦闘","ハンが自力脱出","Bウィングの爆撃"], correct:[0,1,2],
      loc:"タトゥイーン／宮殿→サーラック坑", time:"0:36",
      explain:"交渉決裂→落とし穴でランコア戦→処刑船上の乱戦へ。",
      sources:["https://starwars.fandom.com/wiki/Jabba%27s_Palace","https://starwars.fandom.com/wiki/Rancor"] },
    { q:"ルークの新しいライトセーバーの色",
      multi:false, choices:["緑","青","紫","赤","黄"], correct:[0],
      loc:"タトゥイーン／サンド海（スキッフ上）", time:"0:36",
      explain:"EP6では緑ブレードの自作セーバーを使用。",
      sources:["https://starwars.fandom.com/wiki/Lightsaber#Green_blade"] },
    { q:"反乱軍の女性指導者（エピソード6で登場）",
      multi:false, choices:["モン・モスマ","パドメ","レイアの母の侍女","アミダラ女王","ベイル・オーガナ"], correct:[0],
      loc:"反乱軍司令部（ブリーフィング室）", time:"0:50",
      explain:"モン・モスマが作戦説明を行います。",
      sources:["https://www.starwars.com/news/6-things-you-might-not-know-about-mon-mothma","https://www.starwars.com/news/who-is-mon-mothma"] },
    { q:"反乱軍がエンドアで破壊しようとしたもの",
      multi:false, choices:["シールド発生装置","デス・スター本体","帝国宮殿","イウォークの村","スター・デストロイヤー"], correct:[0],
      loc:"エンドア／発生装置基地", time:"1:13",
      explain:"第二デス・スターの外部防護盾を無効化するのが地上目標。",
      sources:["https://starwars.fandom.com/wiki/Shield_Generator","https://starwars.fandom.com/wiki/Battle_of_Endor"] },
    { q:"イウォークたちが使った原始的な戦術",
      multi:true, choices:["丸太の罠","石投げ","滑空奇襲","火炎放射","対艦ミサイル"], correct:[0,1,2],
      loc:"エンドア／森林", time:"1:30",
      explain:"丸太クラッシャーや投石、滑空奇襲でAT-STを撃破。",
      sources:["https://starwars.fandom.com/wiki/Ewok","https://starwars.fandom.com/wiki/Battle_of_Endor_(ground_battle)"] },
    { q:"ハンとレイアの地上部隊の行動",
      multi:true, choices:["シールド発生装置破壊","AT-ST奪取","ジェダイの寺院占拠","デス・スター突入","イウォークを敵視"], correct:[0,1],
      loc:"エンドア／発生装置基地", time:"1:36",
      explain:"AT-STを鹵獲して陽動→施設破壊に成功。",
      sources:["https://starwars.fandom.com/wiki/All_Terrain_Scout_Transport","https://starwars.fandom.com/wiki/Battle_of_Endor"] },
    { q:"皇帝がルークをダークサイドに誘うために用いた要素",
      multi:true, choices:["友の苦境を見せる","怒りを煽る","父を挑発","大量破壊の脅し","ジェダイ評議会の権威"], correct:[0,1,2,3],
      loc:"第2デス・スター／皇帝の間", time:"1:47",
      explain:"艦隊壊滅の危機を見せ、怒りを焚きつけ、『父』を挑発する定番の揺さぶり。",
      sources:["https://starwars.fandom.com/wiki/Duel_in_the_Emperor%27s_Throne_Room"] },
    { q:"ベイダーの最期に関する事象",
      multi:true, choices:["皇帝を投げ落とす","仮面を外す","ルークと和解","生存して逃走","ジェダイとして葬られる"], correct:[0,1,2,4],
      loc:"第2デス・スター／皇帝の間→反乱軍式典", time:"2:02",
      explain:"ルークを救うために皇帝を処分→父子の和解→霊体としても登場。",
      sources:["https://starwars.fandom.com/wiki/Anakin_Skywalker#Redemption","https://starwars.fandom.com/wiki/Emperor%27s_Throne_Room"] },
    { q:"最後の祝宴シーンで登場する打楽器の形として確認できるもの",
      multi:true, choices:["丸太型","改造されたストームトルーパーのヘルメット","箱型","皿型","三角柱"], correct:[0,1],
      loc:"エンドア／イウォークの村", time:"2:06",
      explain:"ストームトルーパーのヘルメットを太鼓代わりに使う小道具が映ります。",
      sources:["https://starwars.fandom.com/wiki/Ewok"] },
    { q:"フォースの霊体として現れた人物",
      multi:true, choices:["アナキン","オビ＝ワン","ヨーダ","パルパティーン","メイス・ウィンドゥ"], correct:[0,1,2],
      loc:"エンドア／祝宴後の場面", time:"2:08",
      explain:"霊体はヨーダ→オビ＝ワン→アナキンの順で並びます。",
      sources:["https://starwars.fandom.com/wiki/Force_spirit"] }
  ]
};


/* ========= 設定：視聴順 =========
   指定された順 [4,6,1,3] を最優先に並べ、残り（例:2,5）は後ろへ昇順で付与します。
*/
const VIEW_ORDER_PREF = [4,5,6,1,2,3];
function getEpisodeList(){
  const all = Object.keys(QA).map(n=>parseInt(n,10));
  const pref = VIEW_ORDER_PREF.filter(ep=>all.includes(ep));
  const rest = all.filter(ep=>!VIEW_ORDER_PREF.includes(ep)).sort((a,b)=>a-b);
  return [...pref, ...rest];
}

/* ========= 状態 ========= */
const STORE_KEY = "sw16_mc_v4_noedit_nosearch_customorder";
let state = {
  episode: getEpisodeList()[0],
  answers:{},    // {"ep-idx":[choiceIdxs]}
  graded:{},     // {"ep-idx": {ok, partial, score}}
  lastSummary:null,
  filters:{ onlyUnanswered:false, showExplain:true, showAnswers:false }
};

/* ========= 便利関数 ========= */
function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
function load(){ try{ const raw=localStorage.getItem(STORE_KEY); if(raw) state={...state, ...JSON.parse(raw)}; }catch{} }
function escapeHTML(s){ return String(s??"").replace(/[&<>]/g,c=>({'&':'&amp;','<':'&gt;','>':'&lt;'}[c])); }

/* ========= 要素 ========= */
const bar=document.getElementById("bar"); const progressPct=document.getElementById("progressPct");
const tabsEl=document.getElementById("tabs"); const quizZone=document.getElementById("quizZone");
const showAnswersEl=document.getElementById("showAnswers");
const showExplainEl=document.getElementById("showExplain");
const onlyUnansweredEl=document.getElementById("onlyUnanswered");

/* ========= タブ ========= */
function initTabs(){
  tabsEl.innerHTML="";
  const order = getEpisodeList();
  if(!QA[state.episode]) state.episode = order[0];
  for(const ep of order){
    const b=document.createElement("button");
    b.className="tab"+(state.episode===ep?" active":"");
    b.textContent=`EP${ep}`;
    b.onclick=()=>{ state.episode=ep; renderQuiz(); save(); };
    tabsEl.appendChild(b);
  }
}

/* ========= レンダリング ========= */
function renderQuiz(){
  initTabs();
  quizZone.innerHTML="";
  const ep = state.episode;
  const list = QA[ep].map((item, idx)=>({idx, ...item}));
  const onlyUn = !!state.filters.onlyUnanswered;
  const showAns = !!state.filters.showAnswers;
  const showEx  = !!state.filters.showExplain;

  list.filter(item=>{
    const key=`${ep}-${item.idx}`;
    if(onlyUn && (state.answers[key]||[]).length>0) return false;
    return true;
  }).forEach((item, i)=>{
    const key=`${ep}-${item.idx}`;
    const sel = new Set(state.answers[key]||[]);
    const locTxt = item.loc ?? "";
    const timeTxt = item.time ?? "";

    const box=document.createElement("div"); box.className="q";
    const title=document.createElement("h3");
    const typeLabel = item.multi? "（複数選択可）":"（1つ選択）";
    title.innerHTML=`${i+1}. ${escapeHTML(item.q)} <span class="meta">${typeLabel}</span>`;
    box.appendChild(title);

    // タグ（場所・時間）
    const tag=document.createElement("div"); tag.className="tagbar meta";
    tag.innerHTML = `場所: <b>${escapeHTML(locTxt||"—")}</b> / 目安タイム(Disney+): <b>${escapeHTML(timeTxt||"—:—")}</b>`;
    box.appendChild(tag);

    const opts=document.createElement("div"); opts.className="opts";
    item.choices.forEach((text, ci)=>{
      const lbl=document.createElement("label"); lbl.className="opt";
      const input=document.createElement("input");
      input.type = item.multi? "checkbox":"radio";
      input.name = `q-${key}`;
      input.value = ci;
      input.checked = sel.has(ci);
      input.onchange = ()=>{
        if(item.multi){
          const set=new Set(state.answers[key]||[]);
          if(input.checked) set.add(ci); else set.delete(ci);
          state.answers[key]=[...set];
        }else{
          state.answers[key]=[ci];
        }
        updateProgress(); save();
      };
      const span=document.createElement("span");
      span.innerHTML = `<b>${String.fromCharCode(65+ci)}.</b> ${escapeHTML(text)}`;
      lbl.appendChild(input); lbl.appendChild(span); opts.appendChild(lbl);
    });
    box.appendChild(opts);

    if(showAns){
      const ans=document.createElement("div"); ans.className="meta";
      const ansTxt = item.correct.map(i=>`${String.fromCharCode(65+i)}:${item.choices[i]}`).join(" / ");
      ans.innerHTML=`<span>正解:</span> ${escapeHTML(ansTxt)}`;
      box.appendChild(ans);
    }

    // 解説
    if(showEx){
      const det=document.createElement("details"); det.className="ex"; det.open=false;
      const links = (item.sources||[]).map(u=>`<a href="${u}" target="_blank" rel="noopener">${escapeHTML(u)}</a>`).join(" ・ ");
      det.innerHTML = `<summary>解説・出典</summary>
        <div class="meta" style="margin:6px 0 8px 0">${escapeHTML(item.explain||"")}</div>
        <div class="meta">出典: ${links||"—"}</div>`;
      box.appendChild(det);
    }

    // 採点済みラベル
    const judge=state.graded[key];
    if(judge){
      const j=document.createElement("div"); j.className="judge "+(judge.ok?"correct":(judge.partial?"partial":"wrong"));
      j.textContent = judge.ok? "正解 ✔" : (judge.partial? "部分正解 △" : "不正解 ✖");
      box.appendChild(j);
    }

    quizZone.appendChild(box);
  });

  updateProgress();
}

function updateProgress(){
  const total = Object.values(QA).reduce((s,a)=>s+a.length,0);
  const answered = Object.keys(QA).reduce((sum,ep)=> sum + QA[ep].filter((q,idx)=> (state.answers[`${ep}-${idx}`]||[]).length>0).length, 0);
  const pct = Math.round(100*answered/total); bar.style.width=pct+"%"; progressPct.textContent=pct+"%";
}

// ========= 採点（範囲指定版） =========
function gradeNow(scope='ep', ep=state.episode){
  const keys = [];
  const perEp = {};
  const pushKey = (e, i) => { keys.push([e,i]); perEp[e] ??= {ok:0, pt:0, total:0}; perEp[e].total++; };

  if(scope === 'ep'){
    for(let i=0;i<QA[ep].length;i++) pushKey(ep, i);
  }else if(scope === 'answered'){
    for(let e of getEpisodeList()){
      for(let i=0;i<QA[e].length;i++){
        const key = `${e}-${i}`;
        if((state.answers[key]||[]).length>0) pushKey(e, i);
      }
    }
  }else{ // 'all'
    for(let e of getEpisodeList()) for(let i=0;i<QA[e].length;i++) pushKey(e, i);
  }

  if(keys.length===0){
    alert("採点対象がありません。まずは問題を回答してください。");
    return state.lastSummary || {score:0,partial:0,total:0,pct:0,perEp:{},wrongRows:[],scope,episode:ep};
  }

  let score=0, partial=0, total=0;
  keys.forEach(([e,i])=>{
    const q = QA[e][i]; const key=`${e}-${i}`;
    total++;
    const user = new Set(state.answers[key]||[]);
    const gold = new Set(q.correct);
    const inter = [...user].filter(x=>gold.has(x)).length;
    const eq = inter===gold.size && inter===user.size && gold.size>0;
    const res = { ok:eq, partial:(!eq && inter>0), score: eq?1:(inter>0?inter/gold.size:0) };
    state.graded[key]=res;
    if(res.ok){ score++; perEp[e].ok++; }
    else if(res.partial){ partial++; perEp[e].pt++; }
  });

  const summary = {
    score, partial, total,
    pct: total? Math.round(100*score/total) : 0,
    perEp,
    wrongRows: collectWrongRowsFiltered(keys),
    scope, episode: ep
  };
  state.lastSummary=summary; save(); return summary;
}

function collectWrongRowsFiltered(keys){
  const rows=[];
  keys.forEach(([ep, idx])=>{
    const q=QA[ep][idx]; const key=`${ep}-${idx}`;
    const g=state.graded[key]; if(!g || g.ok) return;
    const userIdxs = state.answers[key]||[];
    const userTxt = userIdxs.length ? userIdxs.map(i=>`${String.fromCharCode(65+i)}:${q.choices[i]}`).join(" / ") : "（未選択）";
    const goldTxt = q.correct.map(i=>`${String.fromCharCode(65+i)}:${q.choices[i]}`).join(" / ");
    rows.push({ep,q:q.q,user:userTxt,gold:goldTxt,verdict:g.partial?"部分":"誤答"});
  });
  return rows;
}

/* ========= 結果ビュー ========= */
function renderResults(){
  const s = state.lastSummary || gradeNow('ep', state.episode);
  const badge = document.getElementById("modeBadge");
  const scopeLabel = s.scope==='ep' ? `このEPのみ（EP${s.episode})` :
                     s.scope==='answered' ? "回答済みのみ" : "全エピソード";
  badge.textContent = `採点範囲：${scopeLabel}／完全一致採点（部分は参考）`;

  document.getElementById("statCorrect").textContent = s.score;
  document.getElementById("statPartial").textContent = s.partial;
  document.getElementById("statTotal").textContent = s.total;
  document.getElementById("statPct").textContent = s.pct + "%";

  const tbody=document.querySelector("#epBreakdown tbody"); tbody.innerHTML="";
  Object.keys(s.perEp).map(Number).sort((a,b)=>a-b).forEach(ep=>{
    const d=s.perEp[ep]; const rate=Math.round(100*d.ok/Math.max(1,d.total));
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>EP${ep}</td><td class="ok">${d.ok}</td><td class="pt">${d.pt}</td><td>${d.total}</td><td>${rate}%</td>`;
    tbody.appendChild(tr);
  });

  const wtbody=document.querySelector("#wrongTable tbody"); wtbody.innerHTML="";
  if(s.wrongRows.length===0){
    const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="5" class="ok">見直し対象はありません。完璧です。</td>`; wtbody.appendChild(tr);
  }else{
    s.wrongRows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>EP${r.ep}</td><td>${escapeHTML(r.q)}</td><td>${escapeHTML(r.user)}</td><td>${escapeHTML(r.gold)}</td><td class="${r.verdict==='誤答'?'ng':'pt'}">${r.verdict}</td>`;
      wtbody.appendChild(tr);
    });
  }
}

/* ========= イベント ========= */
document.getElementById("grade").onclick=()=>{
  const scope = document.getElementById("gradeScope").value;
  gradeNow(scope, state.episode);
  if(location.hash!=="#results"){ history.pushState({}, "", "#results"); }
  route();
};
document.getElementById("backToQuiz").onclick=()=>{ history.pushState({}, "", "#"); route(); };
document.getElementById("printPage").onclick=()=>window.print();
document.getElementById("printPage2").onclick=()=>window.print();

document.getElementById("exportData").onclick=()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="sw_quiz_result.json"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
};

// 全消しリセット
document.getElementById("resetAll").onclick=()=>{
  if(!confirm("全データ（回答・採点・設定）をリセットします。よろしいですか？")) return;
  localStorage.removeItem(STORE_KEY);
  state = { episode:getEpisodeList()[0], answers:{}, graded:{}, lastSummary:null, filters:{ onlyUnanswered:false, showExplain:true, showAnswers:false } };
  renderQuiz(); updateProgress();
  if(location.hash==="#results"){ history.pushState({}, "", "#"); }
  route();
};

showAnswersEl.onchange = ()=>{ state.filters.showAnswers = showAnswersEl.checked; save(); renderQuiz(); };
showExplainEl.onchange = ()=>{ state.filters.showExplain = showExplainEl.checked; save(); renderQuiz(); };
onlyUnansweredEl.onchange = ()=>{ state.filters.onlyUnanswered = onlyUnansweredEl.checked; save(); renderQuiz(); };
window.addEventListener("hashchange", route);

/* ========= ルーティング ========= */
const viewQuiz    = document.getElementById("view-quiz");
const viewResults = document.getElementById("view-results");

// 両面とも display は grid のまま（absolute 重ね合わせでスライド）
viewQuiz.style.display = "grid";
viewResults.style.display = "grid";

function route(){
  const toResults = (location.hash === "#results");
  if (toResults) renderResults();
  document.body.classList.toggle("only-results", toResults);
  window.scrollTo({ top: 0, behavior: "auto" });
}

/* ========= ちょこっと演出 ========= */
function enhanceDetails(){
  document.querySelectorAll('details.ex').forEach(d=>{
    const onToggle=()=>{ requestAnimationFrame(()=> d.classList.toggle('open', d.open)); };
    d.addEventListener('toggle', onToggle);
    d.classList.toggle('open', d.open);
  });
}
function headerShadowOnScroll(){
  const h=document.querySelector('header');
  const onS=()=> h.classList.toggle('scrolled', window.scrollY>6);
  window.addEventListener('scroll', onS, {passive:true}); onS();
}
function microHaptics(){
  document.querySelectorAll('.tab,button').forEach(el=>{
    el.addEventListener('click', ()=> { el.style.transform='scale(.98)'; setTimeout(()=> el.style.transform='', 90); });
  });
}
// （ふわっとフェードはそのまま使いたければ有効化）
function softRouteFade(){
  const fade = (el,show)=>{ el.style.opacity=show?0:1; el.style.transition='opacity 220ms';
    requestAnimationFrame(()=> el.style.opacity=show?1:0); };
  const origRoute = route;
  route = function(){
    const quiz=document.getElementById('view-quiz');
    const results=document.getElementById('view-results');
    fade(quiz, location.hash!=="#results");
    fade(results, location.hash==="#results");
    origRoute();
  }
}

/* ========= render 上書き（描画後に高さ同期も呼ぶ） ========= */
const _origRenderQuiz = renderQuiz;
renderQuiz = function(){
  _origRenderQuiz();
  enhanceDetails();
  microHaptics();
  window.__syncMainHeight && window.__syncMainHeight();   // ★ 追加
};
const _origRenderResults = renderResults;
renderResults = function(){
  _origRenderResults();
  window.__syncMainHeight && window.__syncMainHeight();   // ★ 追加
};

/* ========= スライド式画面遷移（高さ同期つき） ========= */
(function enableSlideTransitions(){
  const main   = document.querySelector('main.wrap.grid');
  const quiz   = document.getElementById('view-quiz');
  const results= document.getElementById('view-results');

  // 片面だけを表示（display:none）する素直な出し分け
  function showActive(){
    const isResults = (location.hash === "#results");
    quiz.classList.toggle('hide',  isResults);
    results.classList.toggle('hide', !isResults);
  }

  // 遷移アニメ（スライド中のみ absolute で重ねる）
  async function animateSwap(direction){
    const toResults = (location.hash === "#results");
    const from = toResults ? quiz : results;   // 直前の面
    const to   = toResults ? results : quiz;   // これから出す面

    if (from === to){
      window.__syncMainHeight && window.__syncMainHeight();
      return;
    }

    main.classList.add('animating');   // ← CSS側で .view を absolute に切替
    from.classList.remove('hide');
    to.classList.remove('hide');
    to.classList.add(direction === "forward" ? "enter-from-right" : "enter-from-left");

    await new Promise(r => requestAnimationFrame(r));

    const done = Promise.all([ waitTransitionEnd(from), waitTransitionEnd(to) ]);
    from.classList.add(direction === "forward" ? "exit-to-left" : "exit-to-right");
    to.classList.remove('enter-from-right','enter-from-left');

    await done;

    // 片付け：非表示面は display:none に戻す（ダブルスクロール防止）
    from.classList.remove('exit-to-left','exit-to-right');
    showActive();

    main.classList.remove('animating');  // ← 通常レイアウトへ戻す
    window.__syncMainHeight && window.__syncMainHeight();
  }

  function waitTransitionEnd(el){
    return new Promise(resolve=>{
      const handler=(e)=>{ if(e.target===el){ el.removeEventListener('transitionend', handler); resolve(); } };
      el.addEventListener('transitionend', handler);
      setTimeout(()=>{ el.removeEventListener('transitionend', handler); resolve(); }, 500);
    });
  }

  // --- ここから追記（IIFEの内側） ---
  let lastHash = location.hash;

  // 既存の route を拝借して、描画→アニメの順に実行
  const originalRoute = route;
  route = function(){
    const prev = lastHash;
    const next = location.hash;

    // まず既存の描画（結果数値などを更新）
    originalRoute();

    // 初回起動やハッシュ不変なら、片面だけ見せて終了
    if (prev === next){
      showActive();
      window.__syncMainHeight && window.__syncMainHeight();
      return;
    }

    // スライド方向を決定してアニメーション
    const direction =
      (prev !== "#results" && next === "#results") ? "forward" :
      (prev === "#results" && next !== "#results") ? "back"    :
      "forward";

    animateSwap(direction);
    lastHash = next;
  };

  // 起動直後：現在のハッシュに合わせて片面のみ表示
  showActive();
  // --- 追記ここまで ---
})();

 

/* ========= 起動 ========= */
(function start(){
  load();
  if(!QA[state.episode]) state.episode = getEpisodeList()[0];
  renderQuiz(); route(); updateProgress();
})();
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js'));
}
</script>
</body>
</html>















